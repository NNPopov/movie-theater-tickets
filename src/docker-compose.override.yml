version: '3.8'

# The default docker-compose.override file can use the "localhost" as the external name for testing web apps within the same dev machine.
# The ESHOP_EXTERNAL_DNS_NAME_OR_IP environment variable is taken, by default, from the ".env" file defined like:
#     ESHOP_EXTERNAL_DNS_NAME_OR_IP=localhost
# but values present in the environment vars at runtime will always override those defined inside the .env file
# An external IP or DNS name has to be used (instead localhost and the 10.0.75.1 IP) when testing the Web apps and the Xamarin apps from remote machines/devices using the same WiFi, for instance.

services:
  nginx:
    volumes:
      - ./build/nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./build/nginx/localhost.crt:/etc/ssl/certs/localhost.crt
      - ./build/nginx/localhost.key:/etc/ssl/private/localhost.key
    ports:
      - "9443:443"
      - "9442:80"
  booking-management-postgres:
    ports:
      - "5452:5432"
  booking-management-api:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__Redis=cinema-booking-cache:6379
      - ConnectionStrings__BookingManagementDB=booking-management-postgres:5432
      - SERILOG__USING__1:Serilog.Sinks.Seq
      - SERILOG__WRITETO__1__ARGS__SERVERURL=http://logger-seq
      - SERILOG__WRITETO__1__NAME=Seq
#    ports:
#      - "9453:80"
  cinema-booking-cache:
    ports:
      - "6379:6379"
  logger-seq:
    ports:
      - "8172:80"
      - "8443:5341"
  sso-postgres:
    ports:
      - "5442:5432"
  sso:
    volumes:
    - ./build/keycloak:/opt/keycloak/data/import:ro
    command:
      - start-dev
      - --http-port=80
      - --proxy edge
      - --import-realm
    ports:
      - "8080:80"
      - "18443:443"
      - "19990:9990"